#!/usr/bin/env python
from MyExecPkg import ExecGit
import sys;
import os;

#initialize objects
execgit = ExecGit()

def print_help():
   print( "help:" )
   print( "\tmy_checkin <jira>\n" )
   print( "INFO: jira - jira number to use for the commit" )

def getUnCommittedFiles():
    git_status_cmd = ["git", "status", "--porcelain"]
    retCode,retErr,retStr = execgit.execCommand(git_status_cmd)
    listOfFilesAndStatus = retStr.split('\n')
    listOfFilesAndStatus.pop()
    addModList = []
    for item in listOfFilesAndStatus:
        item = item[2:]
        item = item.strip()
        item = item.strip('\0')
        item = item.strip('\n')
        addModList.append(item)
    return addModList

def checkUnTrackedFiles(othersList):
    #print(othersList)
    if(len(othersList) > 0):
        print("ERROR: following files are untracked. Fix them before proceeding" )
        for item in othersList:
            print(item)
        sys.exit(1)

def getListOfPackages(addModList):
    #print(addModList)
    listOfPackages = []
    for item in addModList:
        splitPath = item.split(os.path.sep)
        #print(splitPath)
        if( len(splitPath) > 1 ):
            listOfPackages.append(splitPath[0])
    if( len(listOfPackages) > 0 ):
        print( "\nINFO: ***** list of packages to be checked in *****\n" )
    for item in listOfPackages:
        print item
    return listOfPackages

#git diff-tree --no-commit-id --name-only -r 8e9d4af83dae5e2c91834126eaffe2919192dcd8
def getSetOfPackagesFromCommits(commits):
    listOfPackages = []
    for commit in commits:
        git_diff_cmd = ["git", "diff-tree", "--no-commit-id", "--name-only", "-r", commit ]
        retCode,retErr,retStr = execgit.execCommand(git_diff_cmd)
        fileList = retStr.split("\n");
        for item in fileList:
            item = item.strip(' ')
            item = item.strip('\0')
            item = item.strip('\n')
            splitPath = item.split(os.path.sep)
            #print(splitPath)
            if( len(splitPath) > 1 ):
                 packageName = splitPath[0]
                 listOfPackages.append(packageName)

    #print("list of packages:")
    #print(listOfPackages)
    setOfPackages = set(listOfPackages)
    return setOfPackages

        
def getListOfCommitNumbers():
    git_cherry_cmd = ["git", "cherry"]
    retCode,retErr,retStr = execgit.execCommand(git_cherry_cmd)
    commits = retStr.split('\n')
    commitnumbers = []
    for item in commits:
         commitList = item.split(' ')
         if(len(commitList) < 2 ):
             continue
         #print("commit list")
         #print(commitList)
         commitnum = commitList[1]
         commitnum = commitnum.strip(' ')
         commitnum = commitnum.strip('\0')
         commitnum = commitnum.strip('\n')
         commitnumbers.append(commitnum)
    return commitnumbers

def getListOfCommits():
    git_cherry_cmd = ["git", "cherry", "-v"]
    retCode,retErr,retStr = execgit.execCommand(git_cherry_cmd)
    commits = retStr.split('\n')
    return commits

def change_versions_for_packages(setOfPackages):
    retCode = 0
    for item in setOfPackages:
        packageName = item
        filename = packageName + os.path.sep + "pkg.version"
        print("INFO: checking in package " + packageName)
        if( retCode == 0 ):
            #print(retStr)
            fd = open(filename, "r")
            version = fd.read()
            fd.close()
            version = version.strip('\n')
            #print(version)
            versionlist = version.split('.')
            versionlistnum = map(lambda x: int(x), versionlist)
            minorchange = map(lambda x: x, versionlistnum)
            minorchange[2] = minorchange[2] + 1
            majorchange = map(lambda x: x, versionlistnum)
            majorchange[0] = majorchange[0] + 1
            midchange = map(lambda x: x, versionlistnum)
            midchange[1] = midchange[1] + 1
            midchangestr = reduce(lambda x,y: str(x) + "." + str(y), midchange)
            minorchangestr = reduce(lambda x,y: str(x) + "." + str(y), minorchange)
            majorchangestr = reduce(lambda x,y: str(x) + "." + str(y), majorchange)
            print("option 0 : " + minorchangestr)
            print("option 1 : " + midchangestr)
            print("option 2 : " + majorchangestr)
            userValueInt = -1
            while (userValueInt < 0 or userValueInt > 2):
               userValue = execgit.getUserValue("Enter option (0,1,2 or enter skip):") 
               if( userValue == "skip" ):
                   print("INFO: check in aborted")
                   sys.exit(1)
               userValueInt = int(userValue)

            if( userValueInt == 0 ):
                versionStr = minorchangestr
            elif( userValueInt == 1):
                versionStr = midchangestr
            elif(userValueInt == 2 ):
                versionStr = majorchangestr
            fd = open(filename, "w+")
            fd.write(versionStr)
            fd.close()
            add_pkg_version_cmd = ["git", "add", filename]
            retCode,retErr,retStr = execgit.execCommand(add_pkg_version_cmd)

def amend_last_commit():
    jira = sys.argv[1]
    git_commit_cmd = ["git", "commit", "--amend" , "-m", jira]
    retCode,retErr,retStr = execgit.execCommand(git_commit_cmd)


def push_changes():
    #print("commits to be pushed" )
    #get current branch
    get_current_branch = ["git", "rev-parse", "--abbrev-ref", "HEAD"]
    retCode,retErr,retStr = execgit.execCommand(get_current_branch)
    branch = retStr.strip(' ')
    branch = branch.strip('\0')
    branch = branch.strip('\n')
    if( branch == "master" or branch == "develop" ):
          print("ERROR: unexpected branch name " + branch )
          sys.exit(-1)
    git_push_cmd = ["git", "push", "origin", branch ]
    retCode,retErr,retStr = execgit.execCommand(git_push_cmd)

def add_notes_to_commit(commit):
    #print(commit)
    git_add_notes_cmd = ["git", "notes", "add", "-f", "-m", '"checked-in-by-script"', commit ]
    #print(git_add_notes_cmd)
    retCode,retErr,retStr = execgit.execCommand(git_add_notes_cmd)

def main():
    if(len(sys.argv) != 2 ):
        print_help()
        sys.exit(1)

    #cannot check in if there are uncommitted files
    unCommittedList = getUnCommittedFiles()
    if( len(unCommittedList) > 0 ):
        print("INFO: Cannot check in as there are uncommitted files")
        print("INFO: Following files are uncommitted. please commit these files and try check in again" )
        for item in unCommittedList :
            print (item)
        sys.exit(-1)

    #get list of commits
    commits = getListOfCommitNumbers()
    #All data is available - do work
    if( len(commits) == 0 ):
        print("INFO: nothing to check in" )
        sys.exit(1)


    # there are commits to be pushed. Find out if version numbers need to be changed
    setOfPackages = getSetOfPackagesFromCommits(commits)
    lastCommit = commits[len(commits)-1]
    if ( len(setOfPackages) == 0): #there are commits to be pushed
        #add_notes_to_commit(lastCommit)
        #get the commits again as they change due to the amend
        commits = getListOfCommitNumbers()
        for commit in commits:
	    add_notes_to_commit(commit)
        push_changes()
    else:
	change_versions_for_packages(setOfPackages)
        #add_notes_to_commit(lastCommit)
        amend_last_commit() #needed because the version numbers have changed
        #get the commits again as they change due to the amend
        commits = getListOfCommitNumbers()
        for commit in commits:
	    add_notes_to_commit(commit)
        push_changes()

    print("INFO: changes successfully checked in!" )
               
main()
